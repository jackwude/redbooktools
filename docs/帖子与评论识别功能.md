# 小红书舆情分析工具 - 帖子与评论识别功能

## 功能说明

系统现在能够智能识别小红书截图中的：
1. **帖子主体内容**（标题、正文、作者、互动数据等）
2. **评论内容**（评论者、评论文字、点赞数、回复等）

并将两者明确区分，便于后续分析。

## 识别逻辑

### 1. 截图类型自动识别
系统会自动判断截图类型：
- **detail_view（详情页）**: 包含完整帖子内容和评论区的截图
- **feed_view（信息流）**: 包含多个帖子封面的瀑布流截图

### 2. 内容区分规则

#### 帖子主体内容（位于截图上部）
- 帖子标题（大号字体，通常在顶部）
- 帖子正文内容（标题下方的文字描述）
- 作者信息（昵称、头像）
- 发布时间
- 互动数据（点赞数、收藏数、评论数）
- 帖子标签、话题（#开头的内容）

#### 评论内容（位于截图下部）
- 评论者昵称
- 评论文字内容
- 评论的点赞数
- 评论时间
- 子评论/回复
- 是否为作者回复

## 数据结构

### API 响应数据格式
```json
{
  "post_content": {
    "title": "帖子标题",
    "content": "帖子正文内容",
    "author": "作者昵称",
    "publish_time": "发布时间",
    "likes": 1200,
    "collects": 300,
    "comments_count": 50,
    "tags": ["标签1", "标签2"]
  },
  "comments": [
    {
      "author": "评论者昵称",
      "content": "评论内容",
      "likes": 10,
      "time": "2小时前",
      "is_author_reply": false,
      "replies": [
        {
          "author": "回复者昵称",
          "content": "回复内容"
        }
      ]
    }
  ],
  "screenshot_type": "detail_view",
  "notes": "识别说明"
}
```

### 分析报告数据结构
分析报告中新增了以下字段：
- `total_comments`: 识别的评论总数
- `comments`: 评论详情列表，包含：
  - 评论者信息
  - 评论内容
  - 互动数据
  - 所属帖子关联
  - 来源截图序号

## 代码改动说明

### 1. 图像分析器 (`image_analyzer.py`)
- 更新了 AI 提示词，明确区分帖子内容和评论内容
- AI 会根据截图布局自动判断内容类型
- 返回结构化的数据，包含帖子和评论的详细信息

### 2. 数据模型 (`schema/response.py`)
新增数据模型：
- `CommentReply`: 评论回复信息
- `CommentInfo`: 评论信息
- `AnalysisReport` 中添加 `comments` 和 `total_comments` 字段

### 3. API 路由 (`api/routes.py`)
- 智能处理不同类型的截图
- 详情页截图：提取帖子内容和评论
- 信息流截图：提取多个帖子封面
- 兼容旧格式数据

### 4. 报告生成器 (`services/report_generator.py`)
- 添加评论数据处理逻辑
- 在最终报告中包含评论信息
- 支持评论的回复层级解析

## 使用示例

### 上传详情页截图
当你上传一张包含帖子详情和评论区的截图时：
1. 系统识别为 `detail_view` 类型
2. 提取帖子标题、正文、互动数据
3. 提取所有可见评论及其回复
4. 在分析报告中分别展示

### 上传信息流截图
当你上传一张包含多个帖子封面的截图时：
1. 系统识别为 `feed_view` 类型
2. 提取每个帖子封面的标题
3. 评论区为空（因为信息流截图没有评论）

## 注意事项

1. **数据准确性**: AI 识别结果依赖于截图的清晰度和完整性
2. **评论关联**: 每条评论会自动关联到所属帖子（通过 `post_title` 字段）
3. **截图序号**: 所有数据都会标注来源截图序号，便于追溯
4. **兼容性**: 系统保持对旧格式数据的兼容

## 后续优化建议

1. **评论情感分析**: 对评论内容进行情感分析
2. **评论热度排序**: 按点赞数或时间排序评论
3. **关键评论提取**: 识别具有代表性的评论
4. **作者互动分析**: 分析作者回复评论的频率和内容
